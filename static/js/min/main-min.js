"use strict";function initialize(){primaryIcons["default"]={url:static_url+"images/primary_marker_default.svg",size:new google.maps.Size(28,42)},primaryIcons.selected={url:static_url+"images/primary_marker_selected.svg",size:new google.maps.Size(28,42)},primaryIcons.hover={url:static_url+"images/primary_marker_hover.svg",size:new google.maps.Size(28,42)},secondaryIcons["default"]={url:static_url+"images/marker_default.png",scaledSize:new google.maps.Size(10,10),anchor:new google.maps.Point(4,4)},secondaryIcons.selected={url:static_url+"images/marker_selected.png",scaledSize:new google.maps.Size(14,14),anchor:new google.maps.Point(7,7)},secondaryIcons.hover={url:static_url+"images/marker_hover.png",scaledSize:new google.maps.Size(10,10),anchor:new google.maps.Point(4,4)},markerIcons.primary=primaryIcons,markerIcons.secondary=secondaryIcons;var e={mapTypeId:google.maps.MapTypeId.TERRAIN,center:{lat:default_lat,lng:default_lng},zoom:6,maxZoom:15,panControl:!1,zoomControl:!1,streetViewControl:!1};0!==$("#map-canvas").length?(map=new google.maps.Map(document.getElementById("map-canvas"),e),map.setOptions({styles:map_styles}),$("#map-canvas").is(":hidden")===!0?resetSearchForm():google.maps.event.addListenerOnce(map,"idle",function(){mapbounds=map.getBounds().toUrlValue()})):resetSearchForm(),$.ajaxSetup({beforeSend:function(e,a){csrfSafeMethod(a.type)||this.crossDomain||e.setRequestHeader("X-CSRFToken",csrftoken)}}),addListMapMoves(),addListSearch(),addListResultClick(),addListResetForm(),addListSportSelection(),createDatePickerComponent(),initializeMapZoomControl(),initializeFromURL()}function csrfSafeMethod(e){return/^(GET|HEAD|OPTIONS|TRACE)$/.test(e)}function getCookie(e){var a=null;if(document.cookie&&""!==document.cookie)for(var t=document.cookie.split(";"),s=0;s<t.length;s++){var n=jQuery.trim(t[s]);if(n.substring(0,e.length+1)===e+"="){a=decodeURIComponent(n.substring(e.length+1));break}}return a}function initializeMapZoomControl(){void 0!==map&&($("#cd-zoom-in").click(function(){map.setZoom(map.getZoom()+1)}),$("#cd-zoom-out").click(function(){map.setZoom(map.getZoom()-1)}))}function initializeSportDistanceHelper(e){$.ajax({url:"ajx/distance/"+e,type:"GET",dataType:"text"}).done(function(e){$("#sport-distances-helper").html(e)}).fail(function(){$("#sport-distances-helper").html("")})}function createDatePickerComponent(){$(".datepicker").datepicker({format:"yyyy-mm-dd",language:"fr",autoclose:!0,clearBtn:!0,todayHighlight:!0,todayBtn:"linked"})}function initializeFromURL(){var e=getParameterByName("sport");""!==e&&saveSportSession(e);var a=getParameterByName("lat_lo"),t=getParameterByName("lat_hi"),s=getParameterByName("lng_lo"),n=getParameterByName("lng_hi");if(""!==a&&""!==t&&""!==s&&""!==n){var r=new google.maps.LatLng(parseFloat(t),parseFloat(s)),o=new google.maps.LatLng(parseFloat(a),parseFloat(n)),i=new google.maps.LatLngBounds(r,o);""===getParameterByName("z")?map.fitBounds(i):(map.setCenter(i.getCenter()),map.setZoom(parseInt(getParameterByName("z")))),mapbounds=i.toUrlValue()}var l=getParameterByName("start_date"),d=getParameterByName("end_date"),c=getParameterByName("search_expr");""!==l&&$("#start_date").val(l),""!==d&&$("#end_date").val(d),""!==c&&$("#search_expr").val(c);var u=getParameterByName("active");selected_event_id=""!==u?parseInt(u):"",getRaces(!1)}function saveSportSession(e){$.ajax({url:"/ajx/sport-session/",data:{sport:e},type:"POST"}).done(function(){var a=e.charAt(0).toUpperCase()+e.slice(1);$(".sport-selected").html(a),selected_sport=a,getRaces(),initializeSportDistanceHelper(e)})}function addListSportSelection(){$(".sport-selecter").on("change",function(e){e.preventDefault(),saveSportSession(e.currentTarget.value)})}function addListMapMoves(){void 0!==map&&google.maps.event.addListener(map,"idle",function(){$("#follow_map_bounds").is(":checked")&&$(".mapbox").is(":visible")&&(mapbounds=map.getBounds().toUrlValue(),getRaces())})}function addListMarkerClick(e){void 0!==map&&google.maps.event.addListener(e,"click",function(){selectEvent(e.get("id")),pushState(getParamQuery(),!1)})}function addListResultClick(){$(".search-result").click(function(e){selectEvent(e.currentTarget.id.replace("event_","")),$(".search-result").removeClass("active"),$(e.currentTarget).addClass("active"),pushState(getParamQuery(),!1)})}function addListSearch(){$("#race_search_form").on("change submit",function(e){e.preventDefault(),getRaces(),selected_event_id=""})}function addListResetForm(){$("#reset-search-form").click(function(){resetSearchForm()})}function addListHoverSideboxResult(){$(".search-result").hover(function(){highlightResult($(this)[0].id.replace("event_",""))},function(){deHighlightResult($(this)[0].id.replace("event_",""))})}function addListHoverMapResult(e){void 0!==map&&(google.maps.event.addListener(e,"mouseover",function(){highlightResult(e.get("id"))}),google.maps.event.addListener(e,"mouseout",function(){deHighlightResult(e.get("id"))}))}function getParamQuery(){var e="undefined"==typeof mapbounds||""===mapbounds?default_boundsarray:mapbounds.split(","),a=$("#race_search_form").serialize()+"&active="+selected_event_id+"&z="+map.getZoom()+"&lat_lo="+e[0]+"&lng_lo="+e[1]+"&lat_hi="+e[2]+"&lng_hi="+e[3];return a}function getRaces(e){e="undefined"==typeof e?!0:e;var a;void 0!==mapbounds?(a=getParamQuery(),a!==last_query&&(ajaxLoad(a),e===!0&&(pushState(a),last_query=a))):$("#map-canvas").is(":hidden")&&(a=getParamQuery(),a!==last_query&&(ajaxLoad(a),e===!0&&(pushState(a),last_query=a)))}function ajaxLoad(e){$("#racelist").html("<div class='spinner'><i class='fa fa-spinner fa-pulse'></i></div>"),$.ajax({url:"ajx/search/",type:"GET",data:e,dataType:"json",timeout:1e4}).done(function(e){refreshRacesOnSidebar(e.html,e.count),refreshRacesOnMap(e.races)}).fail(function(){$("#racelist").html("<div class='alert alert-danger' role='alert'>Une erreur est survenue, veuillez contacter <a href='mailto:contact@esprova.com?subject=[issue]:[ajaxLoad]'>le support</a></div>")})}function refreshRacesOnSidebar(e,a){$("#racelist").html(e),addListResultClick(),addListHoverSideboxResult(),selectEvent(selected_event_id),0===a&&handleNoResult()}function handleNoResult(){var e=$("#try-location-search"),a=e.data("expr"),t=new google.maps.Geocoder;t.geocode({address:a,region:"fr"},function(a,t){if(t==google.maps.GeocoderStatus.OK){if(e.removeClass("hidden"),a.length>0&&a[0].address_components.length>0){var s=a[0].address_components[0].short_name;a[0].address_components.length>1&&(s+=" ("+a[0].address_components[1].short_name+")"),e.children("#location").children("a").text(s)}e.children("#location").click(function(){mapbounds=a[0].geometry.bounds,$("#search_expr").val(""),map.fitBounds(mapbounds)})}}),$("#no-result #cde-remove-keywords").click(function(){$("#search_expr").val(""),getRaces()}),$("#no-result #cde-full-year").click(function(){$("#start_date").val(default_start_date),$("#end_date").val(default_end_date),$("#start_date").datepicker("update"),$("#end_date").datepicker("update"),getRaces()}),$("#no-result #cde-all-distances").click(function(){$(".distance_selector").removeClass("active"),$(this).prop("checked",!1),getRaces()}),$("#no-result #cde-all-distances").click(function(){resetSearchForm()}),$("#no-result #cde-full-map").click(function(){var e=new google.maps.LatLng(default_boundsarray[0],default_boundsarray[1]),a=new google.maps.LatLng(default_boundsarray[2],default_boundsarray[3]),t=new google.maps.LatLngBounds(e,a);map.fitBounds(t),getRaces()})}function refreshRacesOnMap(e){for(var a in markers)markers[a].setMap(null);markers={},$.each(e,function(e,a){var t=a.rankClass,s=new google.maps.LatLng(a.lat,a.lng),n=new google.maps.Marker({position:s,map:map,id:a.id,icon:markerIcons[t]["default"],zIndex:1,rankClass:t});markers[a.id]=n,addListMarkerClick(n),addListHoverMapResult(n)}),selectEvent(selected_event_id)}function selectEvent(e){if(void 0!==markers[selected_event_id]&&$("#event_"+selected_event_id).length&&($("#event_"+selected_event_id).removeClass("active"),a=markers[selected_event_id],a.setIcon(markerIcons[a.rankClass]["default"])),selected_event_id=e,void 0!==markers[selected_event_id]&&$("#event_"+selected_event_id).length){$("#event_"+selected_event_id).addClass("active"),$("#sidebox").animate({scrollTop:$("#sidebox").scrollTop()+$("#event_"+selected_event_id).offset().top-150},500);var a=markers[selected_event_id];a.setIcon(markerIcons[a.rankClass].selected),a.setZIndex(highestZIndex+1),highestZIndex+=1}}function resetSearchForm(){$("#search_expr").val(default_search_expr),$("#start_date").val(default_start_date),$("#end_date").val(default_end_date),$("#start_date").datepicker("update"),$("#end_date").datepicker("update"),$(".distance_selector").removeClass("active"),$(".distance_selector > input").each(function(){$(this).prop("checked",!1)}),getRaces()}function highlightResult(e){if($("#event_"+e).addClass("mouseover"),e!=selected_event_id){var a=markers[e];a.setIcon(markerIcons[a.rankClass].hover)}}function deHighlightResult(e){$("#event_"+e).removeClass("mouseover");var a;e!=selected_event_id?(a=markers[e],a.setIcon(markerIcons[a.rankClass]["default"])):(a=markers[e],a.setIcon(markerIcons[a.rankClass].selected))}function getParameterByName(e){e=e.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var a=new RegExp("[\\?&]"+e+"=([^&#]*)"),t=a.exec(location.search);return null===t?"":decodeURIComponent(t[1].replace(/\+/g," "))}function pushState(e){var a={param_query:e};e!==last_query&&"undefined"!=typeof last_query?(history.pushState(a,"index","/search?"+e),last_query=e):""===location.search&&(history.replaceState(a,"index","/search?"+e),last_query=e)}var map,mapbounds,last_query,markers={},selected_event_id="",selected_sport="",highestZIndex=10,markerIcons={},primaryIcons={},secondaryIcons={},default_lat=46.9,default_lng=2.6,default_boundsarray=[40,-10,60,12],default_search_expr="",default_start_date="2015-01-01",default_end_date="2015-12-31",google;if("undefined"==typeof map_styles)var map_styles=[];"undefined"!=typeof google&&google.maps.event.addDomListener(window,"load",initialize);var csrftoken=getCookie("csrftoken");window.onpopstate=function(e){null!==e.state&&(ajaxLoad(e.state.param_query),google.maps.event.clearListeners(map,"idle"),initializeFromURL(),google.maps.event.addListenerOnce(map,"idle",function(){addListMapMoves()}))};